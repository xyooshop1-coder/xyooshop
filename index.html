<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow a Garden Pets – Store (Firebase CRUD)</title>
  <style>
    :root{
      --brand:#6fbf73; --brand2:#57a85c; --bg:#f4f9f4; --ink:#1e2b22; --muted:#6a7b6d; --card:#fff
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink)}
    header{background:var(--brand); color:#fff; padding:1.75rem 1rem; text-align:center}
    header h1{margin:0; font-size:clamp(1.4rem,3.5vw,2.2rem)}
    header .sub{opacity:.9}

    .container{max-width:1150px; margin:0 auto; padding:1rem}
    .layout{display:grid; grid-template-columns:1fr; gap:1rem}
    @media(min-width:980px){ .layout{ grid-template-columns:2fr 1fr } }

    /* Catalog */
    .toolbar{display:flex; gap:.75rem; align-items:center; margin:.75rem 0}
    .toolbar input[type=text]{flex:1; padding:.7rem .9rem; border-radius:10px; border:1px solid #dfe8e1; background:#fff}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:1rem}
    .card{background:var(--card); border:1px solid #e5eee6; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .card img{width:100%; height:180px; object-fit:cover; background:#eaf3eb}
    .card .body{padding:1rem; display:flex; flex-direction:column; gap:.5rem; flex:1}
    .name{font-weight:750}
    .desc{font-size:.92rem; color:var(--muted); line-height:1.35}
    .priceRow{display:flex; align-items:center; gap:.5rem; margin-top:auto}
    .price{font-weight:800}
    .strike{text-decoration:line-through; color:#9aa7a0; font-weight:600}
    .badge{display:inline-block; background:#f5fdf5; color:#1a7f2e; border:1px solid #cfe8d3; padding:.2rem .5rem; font-size:.73rem; border-radius:999px}
    .out{background:#fff6f6; color:#a33; border-color:#efcaca}
    .actions{display:flex; gap:.5rem; margin-top:.75rem}
    button,.btn{appearance:none; border:none; border-radius:12px; padding:.6rem .9rem; font-weight:700; cursor:pointer; background:var(--brand); color:#fff}
    button:hover{background:var(--brand2)}
    .secondary{background:#eaf3eb; color:#184822}
    .danger{background:#e45d5d}

    /* Cart */
    .cart{position:sticky; top:0; align-self:flex-start; background:#fff; border:1px solid #e5eee6; border-radius:16px; padding:1rem; box-shadow:0 8px 18px rgba(0,0,0,.06)}
    .cart h3{margin:.25rem 0 1rem}
    .cartList{display:flex; flex-direction:column; gap:.75rem; max-height:55vh; overflow:auto}
    .line{display:grid; grid-template-columns:56px 1fr auto; gap:.6rem; align-items:center}
    .line img{width:56px; height:56px; object-fit:cover; border-radius:10px}
    .muted{color:var(--muted)}

    /* Admin */
    .admin{margin-top:1.25rem; background:#fff; border:1px solid #e5eee6; border-radius:16px; padding:1rem}
    .admin h3{margin:0 0 .6rem}
    .admin .row{display:flex; flex-wrap:wrap; gap:.5rem}
    .admin input,.admin textarea, .admin select{padding:.6rem .7rem; border:1px solid #dfe8e1; border-radius:10px}
    .table{width:100%; border-collapse:collapse; margin-top:.75rem}
    .table th,.table td{padding:.6rem .5rem; border-bottom:1px dashed #e7efe8; text-align:left; font-size:.92rem}
    .table img{width:44px; height:44px; object-fit:cover; border-radius:8px}
    .note{font-size:.9rem; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Grow a Garden Pets – Store</h1>
    <p class="sub">Manage products, stock & discounts inside the site. Buyers pay via PayPal.Me.</p>
  </header>

  <div class="container layout">
    <main>
      <div class="toolbar">
        <input id="search" type="text" placeholder="Search pets, seeds, accessories…" />
        <span id="count" class="badge"></span>
        <span id="adminBadge" class="badge" style="display:none">Admin</span>
      </div>
      <section id="catalog" class="grid"></section>
    </main>

    <aside>
      <section class="cart">
        <h3>Your Cart</h3>
        <div id="cartList" class="cartList"></div>
        <div class="summary">
          <div class="row" style="display:flex; justify-content:space-between; margin-top:.6rem"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
          <div class="row" style="display:flex; justify-content:space-between"><span>Discount</span><strong id="discount">-$0.00</strong></div>
          <div class="row" style="display:flex; justify-content:space-between; font-size:1.1rem"><span>Total</span><strong id="total">$0.00</strong></div>
          <button id="payBtn" disabled>Pay with PayPal</button>
        </div>
      </section>

      <section class="admin" id="adminPanel" style="display:none">
        <h3>Admin Panel</h3>
        <div class="note">Sign in to add/edit/delete products. Images are stored in Firebase Storage.</div>
        <div id="authArea" class="row" style="margin:.6rem 0">
          <input id="email" placeholder="Admin email" />
          <input id="password" placeholder="Password" type="password" />
          <button id="loginBtn" class="secondary">Sign In</button>
          <button id="logoutBtn" class="secondary" style="display:none">Sign Out</button>
        </div>

        <details open>
          <summary><strong>Add / Edit Product</strong></summary>
          <div class="row" style="margin:.5rem 0">
            <input id="pId" placeholder="id (auto for new)" />
            <input id="pName" placeholder="Name" />
            <input id="pPrice" placeholder="Price" type="number" step="0.01" />
            <input id="pSale" placeholder="Sale price (optional)" type="number" step="0.01" />
            <input id="pStock" placeholder="Stock" type="number" />
            <select id="pActive">
              <option value="true">Active</option>
              <option value="false">Hidden</option>
            </select>
          </div>
          <textarea id="pDesc" rows="3" placeholder="Description" style="width:100%"></textarea>
          <div class="row" style="margin-top:.5rem">
            <input id="pSku" placeholder="SKU (optional)" />
            <input id="pImgUrl" placeholder="Image URL (auto from upload)" style="flex:1" />
            <input id="pImg" type="file" accept="image/*" />
            <button id="saveBtn">Save Product</button>
            <button id="resetBtn" class="secondary">Reset</button>
          </div>
        </details>

        <table class="table" id="adminTable">
          <thead>
            <tr><th>Img</th><th>Name</th><th>Price</th><th>Sale</th><th>Stock</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </aside>
  </div>

  <!-- Firebase SDKs (compat for simplicity). Replace with your project config below. -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    // ==== 1) EDIT: Your Firebase project config ====
    const firebaseConfig = {
      apiKey: "AIzaSyDQXDOxP_XSt8PWux2ipaKXQG_EzxE9W48",
      authDomain: "xyoo-shop.firebaseapp.com",
      projectId: "xyoo-shop",
      storageBucket: "xyoo-shop.firebasestorage.app",
      messagingSenderId: "671592025442",
      appId: "1:671592025442:web:a8795522a2ae9762b2b03b",
      measurementId: "G-8TJXH0ZJVZ"
    };


    // ==== 2) EDIT: Your PayPal.Me username & currency ====
    const PAYPAL_ME = 'JhonJoross';  // e.g. 'JhonJoross'
    const CURRENCY = 'USD';

    // ===== INIT =====
    let app, db, auth, storage;
    let user = null;
    let unsubCatalog = null;
    const cart = {}; // id -> qty

    const fmt = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:CURRENCY}).format(n);

    function unitPrice(p){ return (p.salePrice && p.salePrice < p.price) ? p.salePrice : p.price; }

    window.addEventListener('DOMContentLoaded', async () => {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
      storage = firebase.storage();

      // Auth UI
      document.getElementById('loginBtn').onclick = async ()=>{
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        try{ await auth.signInWithEmailAndPassword(email,password); }
        catch(e){ alert(e.message); }
      };
      document.getElementById('logoutBtn').onclick = ()=> auth.signOut();

      auth.onAuthStateChanged(u => {
        user = u;
        document.getElementById('logoutBtn').style.display = u? 'inline-block':'none';
        document.getElementById('loginBtn').style.display = u? 'none':'inline-block';
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('adminBadge').style.display = u? 'inline-block':'none';
        refreshAdminTable();
      });

      // Catalog live query
      const searchEl = document.getElementById('search');
      const catalogEl = document.getElementById('catalog');
      searchEl.addEventListener('input', ()=> renderCatalog.lastSnapshot && renderCatalog(renderCatalog.lastSnapshot));

      unsubCatalog = db.collection('products').orderBy('name').onSnapshot(snap => {
        renderCatalog.lastSnapshot = snap; // cache for search filter
        renderCatalog(snap);
      });

      // Admin actions
      document.getElementById('saveBtn').onclick = saveProduct;
      document.getElementById('resetBtn').onclick = resetForm;
      document.getElementById('pImg').addEventListener('change', handleImageUpload);

      document.getElementById('payBtn').onclick = checkoutPayPalMe;

      renderCart();
    });

    // ===== Catalog rendering =====
    function renderCatalog(snap){
      const catalogEl = document.getElementById('catalog');
      const q = (document.getElementById('search').value||'').toLowerCase();
      let docs = snap.docs.map(d=> ({id:d.id,...d.data()}));
      // hide inactive for visitors; admin can still see in admin table
      docs = docs.filter(p => p.active !== false);
      if(q) docs = docs.filter(p => (p.name||'').toLowerCase().includes(q) || (p.desc||'').toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q));

      document.getElementById('count').textContent = `${docs.length} item${docs.length!==1?'s':''}`;

      catalogEl.innerHTML = docs.map(p=>{
        const out = (p.stock||0) <= 0;
        const priceHTML = (p.salePrice && p.salePrice < p.price)
          ? `<span class="strike">${fmt(p.price)}</span> <span class="price">${fmt(p.salePrice)}</span> <span class="badge">Sale</span>`
          : `<span class="price">${fmt(p.price)}</span>`;
        return `
          <article class="card">
            <img src="${p.imageURL||''}" alt="${p.name}">
            <div class="body">
              <div class="name">${p.name||''}</div>
              <div class="desc">${p.desc||''}</div>
              <div class="priceRow">${priceHTML}</div>
              <div class="actions">
                <button ${out? 'disabled':''} onclick="addToCart('${p.id||p._id||''}','${p.name?.replace(/"/g,'&quot;')||''}')">${out? 'Out of Stock':'Add to Cart'}</button>
                ${out? '<span class="badge out">Out</span>' : `<span class="badge">${p.stock||0} in stock</span>`}
              </div>
            </div>
          </article>`
      }).join('');
    }

    // ===== Cart =====
    function addToCart(id){ if(!id) return; cart[id] = (cart[id]||0) + 1; renderCart(); }
    function changeQty(id,qty){ if(qty<=0){ delete cart[id]; } else { cart[id]=qty; } renderCart(); }
    function renderCart(){
      const list = document.getElementById('cartList');
      if(Object.keys(cart).length===0){
        list.innerHTML = '<div class="muted">Your cart is empty.</div>';
        document.getElementById('subtotal').textContent = fmt(0);
        document.getElementById('discount').textContent = '-'+fmt(0).replace('$','');
        document.getElementById('total').textContent = fmt(0);
        document.getElementById('payBtn').disabled = true; return;
      }
      // fetch the current product data for ids in cart
      const ids = Object.keys(cart);
      db.collection('products').where(firebase.firestore.FieldPath.documentId(), 'in', ids.slice(0,10)).get().then(snap=>{
        const rows = [];
        let subtotal = 0;
        snap.forEach(doc=>{
          const p = {id:doc.id, ...doc.data()};
          const qty = Math.min(cart[p.id], p.stock||99);
          const price = unitPrice(p);
          subtotal += price * qty;
          rows.push(`
            <div class="line">
              <img src="${p.imageURL||''}" alt="${p.name}">
              <div>
                <div><strong>${p.name}</strong></div>
                <div class="muted">${fmt(price)} each</div>
                <div style="margin-top:.3rem">
                  <label class="muted" for="q-${p.id}">Qty</label>
                  <input id="q-${p.id}" type="number" min="0" max="${p.stock||99}" value="${qty}" style="width:64px" onchange="changeQty('${p.id}', parseInt(this.value)||0)">
                  <button class="secondary" onclick="changeQty('${p.id}',0)">Remove</button>
                </div>
              </div>
              <div><strong>${fmt(price*qty)}</strong></div>
            </div>`);
        });
        list.innerHTML = rows.join('');
        document.getElementById('subtotal').textContent = fmt(subtotal);
        document.getElementById('discount').textContent = '-'+fmt(0).replace('$','');
        document.getElementById('total').textContent = fmt(subtotal);
        document.getElementById('payBtn').disabled = subtotal<=0;
      });
    }

    function checkoutPayPalMe(){
      // compute cart total and open PayPal.Me link
      const totalText = document.getElementById('total').textContent.replace(/[^0-9.]/g,'');
      const total = parseFloat(totalText||'0').toFixed(2);
      if(total <= 0) return;
      window.open(`https://www.paypal.com/paypalme/${PAYPAL_ME}/${total}${CURRENCY==='USD'?'USD':''}`, '_blank');
    }

    // ===== Admin: CRUD =====
    async function handleImageUpload(e){
      const file = e.target.files[0]; if(!file){return}
      if(!user){ alert('Sign in to upload images.'); e.target.value=''; return; }
      const ref = storage.ref().child(`products/${Date.now()}_${file.name}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      document.getElementById('pImgUrl').value = url;
      alert('Image uploaded. URL filled.');
    }

    function resetForm(){
      ['pId','pName','pDesc','pPrice','pSale','pStock','pSku','pImgUrl'].forEach(id=> document.getElementById(id).value='');
      document.getElementById('pActive').value = 'true';
      document.getElementById('pImg').value='';
    }

    async function saveProduct(){
      if(!user){ alert('Please sign in first.'); return; }
      const id = (document.getElementById('pId').value||'').trim();
      const data = {
        name: document.getElementById('pName').value.trim(),
        desc: document.getElementById('pDesc').value.trim(),
        price: parseFloat(document.getElementById('pPrice').value||0),
        salePrice: document.getElementById('pSale').value? parseFloat(document.getElementById('pSale').value) : null,
        stock: parseInt(document.getElementById('pStock').value||0),
        sku: (document.getElementById('pSku').value||'').trim(),
        imageURL: (document.getElementById('pImgUrl').value||'').trim(),
        active: document.getElementById('pActive').value === 'true',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try{
        if(id){ await db.collection('products').doc(id).set(data, {merge:true}); }
        else { const docRef = await db.collection('products').add(data); document.getElementById('pId').value = docRef.id; }
        alert('Saved!'); refreshAdminTable();
      }catch(e){ alert(e.message); }
    }

    async function deleteProduct(id){
      if(!user){ alert('Sign in first.'); return; }
      if(!confirm('Delete this product?')) return;
      await db.collection('products').doc(id).delete();
      refreshAdminTable();
    }

    function editRow(p){
      document.getElementById('pId').value = p.id;
      document.getElementById('pName').value = p.name||'';
      document.getElementById('pDesc').value = p.desc||'';
      document.getElementById('pPrice').value = p.price||'';
      document.getElementById('pSale').value = p.salePrice ?? '';
      document.getElementById('pStock').value = p.stock||0;
      document.getElementById('pSku').value = p.sku||'';
      document.getElementById('pImgUrl').value = p.imageURL||'';
      document.getElementById('pActive').value = String(p.active !== false);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function refreshAdminTable(){
      const tbody = document.querySelector('#adminTable tbody');
      db.collection('products').orderBy('updatedAt','desc').limit(100).get().then(snap=>{
        const rows = [];
        snap.forEach(doc=>{
          const p = {id:doc.id, ...doc.data()};
          rows.push(`<tr>
            <td><img src="${p.imageURL||''}" alt=""></td>
            <td>${p.name||''}<div class="muted">${p.sku||''}</div></td>
            <td>${p.price!=null? fmt(p.price):''}</td>
            <td>${p.salePrice!=null? fmt(p.salePrice):'-'}</td>
            <td>${p.stock ?? 0}</td>
            <td>${p.active===false? '<span class="badge out">Hidden</span>':'<span class="badge">Active</span>'}</td>
            <td>
              <button class="secondary" onclick='editRow(${JSON.stringify(p).replace(/"/g,"&quot;")})'>Edit</button>
              <button class="danger" onclick="deleteProduct('${p.id}')">Delete</button>
            </td>
          </tr>`);
        });
        tbody.innerHTML = rows.join('');
      });
    }
  </script>

  <!-- SECURITY NOTE: Set Firestore & Storage rules so only authenticated admin can write.
  Example (replace with your project & test carefully):
  rules_version = '2';
  service cloud.firestore { match /databases/{db}/documents {
    match /products/{id} {
      allow read: if true; // public can read catalog
      allow write: if request.auth != null && request.auth.token.email == 'YOUR_ADMIN_EMAIL@domain.com';
    }
  }}
  service firebase.storage { match /b/{bucket}/o {
    match /products/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.email == 'YOUR_ADMIN_EMAIL@domain.com';
    }
  }}
  -->
</body>
</html>
